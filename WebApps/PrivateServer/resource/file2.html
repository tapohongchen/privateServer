<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>æ–‡ä»¶ä¸­å¿ƒ - ç§äººæœåŠ¡å™¨</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Microsoft YaHei", Arial, sans-serif;
      background: linear-gradient(to right, #599cad, #2a5298);
      color: #fff;
    }

    .container {
      text-align: center;
      padding: 60px 20px;
    }

    h1 {
      font-size: 2.5em;
      margin-bottom: 30px;
      color: #aaff00;
    }

    .file-controls {
      margin-bottom: 15px;
      text-align: left;
      font-size: 0.9em;
    }

    .file-controls button {
      margin: 0 10px;
      padding: 6px 14px;
      font-size: 0.9em;
      color: #fff;
      background: linear-gradient(45deg, #00c6ff, #0072ff);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      box-shadow: none;
      transition: all 0.3s ease;
    }

    .file-controls button:hover {
      background-color: #00aaff;
      box-shadow: 0 0 15px #00e1ff;
    }

    .file-upload {
      margin-bottom: 30px;
    }

    .file-upload input[type="file"] {
      padding: 10px;
      background: #444;
      color: #fff;
      border: none;
      border-radius: 8px;
      margin-right: 10px;
    }

    .file-list {
      margin-top: 30px;
      text-align: left;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }

    .file-item {
      background: #2e2e3f;
      padding: 10px 20px;
      margin: 8px 0;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .file-item a, .file-item span.folder {
      color: #00c3ff;
      text-decoration: none;
      cursor: pointer;
    }

    .file-item a:hover, .file-item span.folder:hover {
      background: linear-gradient(45deg, #0072ff, #00c6ff);
      box-shadow: 0 0 15px #00e1ff;
      text-decoration: underline;
    }

    .breadcrumb {
      margin-top: 20px;
      font-size: 0.95em;
      color: #ccc;
    }

    .breadcrumb span {
      cursor: pointer;
      color: #00e1ff;
    }

    .breadcrumb span:hover {
      text-decoration: underline;
    }

  </style>
</head>
<body>
  <div id="logout-bar" style="
    position: absolute;
    top: 8px;
    right: 20px;
    ">
    <button onclick="logout()" style="
        padding: 4px 12px;
        font-size: 0.9em;
        background-color: #ff4d4f;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    ">ğŸšª é€€å‡º</button>
  </div>
  <div class="container">
    <h1>ğŸ“ æ–‡ä»¶ä¸Šä¼ /ä¸‹è½½</h1>

    <!-- ä¸Šä¼ åŒºåŸŸ -->
    <div class="file-upload">
      <form id="uploadForm">
        <label class="file-select">
            ğŸ“‚ é€‰æ‹©æ–‡ä»¶
            <input type="file" name="file" id="fileInput" required>
        </label>
        <button type="submit" class="upload-button">ğŸš€ ä¸Šä¼ </button>
      </form>      
    </div>

    <!-- å½“å‰è·¯å¾„æ˜¾ç¤º -->
    <div class="breadcrumb" id="breadcrumb">å½“å‰ä½ç½®ï¼š/<span onclick="goToRoot()">æ ¹ç›®å½•</span></div>

    <!-- æ–‡ä»¶åˆ—è¡¨ -->
    <div class="file-list" id="file-list">
      <h2>æ–‡ä»¶ä¸æ–‡ä»¶å¤¹ï¼š</h2>
          <!-- æ§åˆ¶æŒ‰é’®åŒºåŸŸ -->
        <div class="file-controls">
            <button onclick="goBack()">ğŸ”™ è¿”å›ä¸Šä¸€å±‚</button>
            <button onclick="createFolder()">ğŸ“‚ æ–°å»ºæ–‡ä»¶å¤¹</button>
        </div>
    </div>
  </div>

  <script>
    document.getElementById("uploadForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const fileInput = document.getElementById("fileInput");
      const file = fileInput.files[0];
      if (!file) {
        alert("è¯·é€‰æ‹©æ–‡ä»¶ï¼");
        return;
      }

      splitAndUpload(file);
    });
    let currentPath = "";
    function logout() {
      fetch('/user/logout', {
          method: 'POST',
          credentials: 'include'
      })
      .then(res => res.json())
      .then(data => {
          if (data.message === "logout successful") {
          window.location.href = "/";
          } else {
          alert("é€€å‡ºå¤±è´¥ï¼š" + data.message);
          }
      })
      .catch(err => {
          console.error("é€€å‡ºè¯·æ±‚å¤±è´¥", err);
          alert("ç½‘ç»œé”™è¯¯ï¼Œé€€å‡ºå¤±è´¥");
      });
    }

    function loadFiles() {
      fetch(`/api/filecenter?path=${encodeURIComponent(currentPath)}`, {
        method: 'GET',
        credentials: 'include'
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            const listContainer = document.getElementById('file-list');
            listContainer.innerHTML = `
                <h2>æ–‡ä»¶ä¸æ–‡ä»¶å¤¹ï¼š</h2>
                <div class="file-controls">
                    <button onclick="goBack()">ğŸ”™ è¿”å›ä¸Šä¸€å±‚</button>
                    <button onclick="createFolder()">ğŸ“‚ æ–°å»ºæ–‡ä»¶å¤¹</button>
                </div>
                `;

            // æ›´æ–°è·¯å¾„æ˜¾ç¤º
            const breadcrumb = document.getElementById('breadcrumb');
            breadcrumb.innerHTML = `å½“å‰ä½ç½®ï¼š/<span onclick="goToRoot()">æ ¹ç›®å½•</span>` + currentPath.split("/").filter(Boolean).map((p, idx, arr) => {
              const partialPath = arr.slice(0, idx + 1).join("/");
              return ` / <span onclick="navigateTo('${partialPath}')">${p}</span>`;
            }).join("");

            data.items.forEach(item => {
              const div = document.createElement('div');
              div.className = 'file-item';

              if (item.type === 'folder') {
                div.innerHTML = `
                  <span class="folder" onclick="enterFolder('${item.name}')">ğŸ“ ${item.name}</span>
                  <span>æ–‡ä»¶å¤¹</span>
                  <button onclick="deleteItem('${item.name}', true)">ğŸ—‘ åˆ é™¤</button>
                `;
              } else {
                div.innerHTML = `
                  <span ondblclick="previewFile('${item.name}')">${item.name}</span>
                  <a href="/download/${encodeURIComponent((currentPath ? currentPath + '/' : '') + item.name)}" download>ä¸‹è½½</a>
                  <button onclick="deleteItem('${item.name}', false)">ğŸ—‘ åˆ é™¤</button>
                `;
              }

              listContainer.appendChild(div);
            });
          } else {
            alert("åŠ è½½å¤±è´¥ï¼š" + data.message);
          }
        })
        .catch(err => {
          console.error("è¯·æ±‚å¤±è´¥", err);
        });
    }

    async function splitAndUpload(file) {
      const muploadResp = await fetch('/file/mupload', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ filename: file.name, filesize: file.size, path: currentPath})
      });

      const muploadData = await muploadResp.json();
      const { uploadID, chunkSize, chunkCount } = muploadData;

      const chunks = [];
      for (let i = 0; i < chunkCount; i++) {
        const start = i * chunkSize;
        const end = Math.min(file.size, start + chunkSize);
        chunks.push(file.slice(start, end));
      }
      // â© ä½¿ç”¨ Promise.all å¹¶å‘ä¸Šä¼ æ‰€æœ‰åˆ†ç‰‡
      const maxRetries = 3;
      const uploadChunk = async (blob, index) => {
        for (let attempt = 0; attempt < maxRetries; attempt++) {
          try {
            const resp = await fetch('/file/uppart', {
              method: 'POST',
              credentials: 'include',
              headers: {
                'Content-Type': 'application/octet-stream', // äºŒè¿›åˆ¶æ•°æ®
                'chunkIndex': index,
                'filename': uploadID
              },
              body: blob
            });

            const data = await resp.json();
            if (data.success) return true;
          } catch (e) {
            console.warn(`ç¬¬ ${index} ä¸ªåˆ†ç‰‡ä¸Šä¼ å¤±è´¥ï¼šé‡è¯• ${attempt + 1}`);
          }
        }
        return false;
      };

      // å¹¶å‘ä¸Šä¼ 
      const results = await Promise.all(chunks.map((chunk, index) => uploadChunk(chunk, index)));
      const failedIndex = results.findIndex(success => !success);
      if (failedIndex !== -1) {
        // æ¸…ç†æœåŠ¡ç«¯
        await fetch('/file/clear', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ filename: file.name })
        });

        alert(`ç¬¬ ${failedIndex + 1} ä¸ªåˆ†ç‰‡ä¸Šä¼ å¤±è´¥å¤šæ¬¡ï¼Œä¸Šä¼ ç»ˆæ­¢`);
        return;
      }

      // å…¨éƒ¨ä¸Šä¼ æˆåŠŸï¼Œåˆå¹¶åˆ†ç‰‡
      const completeResp = await fetch('/file/upcomplete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ filename: file.name })
      });

      const completeData = await completeResp.json();
      if (completeData.success) {
        alert("ä¸Šä¼ å®Œæˆï¼");
        loadFiles();
      } else {
        alert("åˆå¹¶å¤±è´¥ï¼š" + completeData.message);
      }
    }
    function previewFile(name) {
      fetch('/file/preview', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        credentials: 'include',
        body: JSON.stringify({
          path: currentPath,
          filename: name
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          // æ ¹æ® MIME ç±»å‹æˆ–æ–‡ä»¶ç±»å‹åˆ¤æ–­é¢„è§ˆæ–¹å¼
          const url = data.url;
          const type = data.type;

          if (type.startsWith('text/')) {
            window.open(url, '_blank');  // å¯æ‰“å¼€ä¸€ä¸ªæ–°é¡µé¢æŸ¥çœ‹æ–‡æœ¬
          } else if (type.startsWith('video/')) {
            const videoWindow = window.open('', '_blank');
            videoWindow.document.write(`
              <html>
                <head><title>è§†é¢‘é¢„è§ˆ</title></head>
                <body style="margin:0;display:flex;align-items:center;justify-content:center;background:#000;">
                  <video controls autoplay style="max-width:100%;max-height:100%;">
                    <source src="${url}" type="${type}">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
                  </video>
                </body>
              </html>
            `);
            // window.open(url, '_blank');  // ç›´æ¥æ’­æ”¾è§†é¢‘
          } else if (type.startsWith('image/')) {
            window.open(url, '_blank');  // æ˜¾ç¤ºå›¾ç‰‡
          } else if (type.startsWith('application/')) {
            window.open(url, '_blank');  // pdf/zip
          } else {
            alert('æš‚ä¸æ”¯æŒé¢„è§ˆè¯¥ç±»å‹æ–‡ä»¶ï¼Œè¯·ä¸‹è½½åæŸ¥çœ‹');
          }
        } else {
          alert("é¢„è§ˆå¤±è´¥ï¼š" + data.message);
        }
      })
      .catch(err => {
        console.error("é¢„è§ˆå¤±è´¥", err);
      });
    }

    function enterFolder(name) {
      currentPath = currentPath ? `${currentPath}/${name}` : name;
      loadFiles();
    }

    function goBack() {
      if (!currentPath || currentPath === "") {
        alert("å·²ç»åœ¨æ ¹ç›®å½•ï¼Œæ— æ³•è¿”å›ä¸Šä¸€å±‚ã€‚");
        return;
      }
      if (currentPath.includes("/")) {
        currentPath = currentPath.substring(0, currentPath.lastIndexOf("/"));
      } else {
        currentPath = "";
      }
      loadFiles();
    }

    function goToRoot() {
      currentPath = "";
      loadFiles();
    }

    function isValid(name) {
      if (!name || name.trim() === "") {
        alert("æ–‡ä»¶å¤¹åä¸èƒ½ä¸ºç©ºæˆ–ä»…ä¸ºç©ºæ ¼ï¼");
        return false;
      }

      // ç¦æ­¢ç‰¹æ®Šå­—ç¬¦ï¼ˆWindows/Unixé€šç”¨ï¼‰
      const invalidChars = /[\\\/:*?"<>|]/;
      if (invalidChars.test(name)) {
        alert("æ–‡ä»¶å¤¹åä¸èƒ½åŒ…å«ä»¥ä¸‹å­—ç¬¦ï¼š\\ / : * ? \" < > |");
        return false;
      }

      // ç¦æ­¢ .. ç­‰è·¯å¾„ç©¿è¶Šæ“ä½œ
      if (name.includes("..")) {
        alert("æ–‡ä»¶å¤¹åä¸èƒ½åŒ…å« \"..\"");
        return false;
      }

      if (name.length > 15) {
        alert("æ–‡ä»¶å¤¹åè¿‡é•¿ï¼ˆä¸èƒ½è¶…è¿‡15å­—ç¬¦ï¼‰");
        return false;
      }

      return true;
    }



    function createFolder() {
      const name = prompt("è¯·è¾“å…¥æ–°æ–‡ä»¶å¤¹åç§°ï¼š");
      if (!isValid(name)) return;

      fetch('/api/createFolder', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        credentials: 'include',
        body: JSON.stringify({ folderName: name, path: currentPath })
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            alert("æ–‡ä»¶å¤¹åˆ›å»ºæˆåŠŸ");
            loadFiles();
          } else {
            alert("åˆ›å»ºå¤±è´¥ï¼š" + data.message);
          }
        })
        .catch(err => {
          console.error("åˆ›å»ºå¤±è´¥", err);
        });
    }
    function deleteItem(name, isFolder) {
      if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${name} å—ï¼Ÿ`)) return;

      fetch('/api/deleteItem', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        credentials: 'include',
        body: JSON.stringify({
          target: name,
          path: currentPath,
          isFolder: isFolder
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert("åˆ é™¤æˆåŠŸ");
          loadFiles();
        } else {
          alert("åˆ é™¤å¤±è´¥ï¼š" + data.message);
        }
      })
      .catch(err => {
        console.error("åˆ é™¤å¤±è´¥", err);
      });
    }

    // åˆå§‹åŒ–åŠ è½½
    document.addEventListener('DOMContentLoaded', loadFiles);
  </script>
</body>
</html>
